<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatikus Feliratozó és Fordító</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: auto; }
        .container { background: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        input, select, button, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: #337ab7; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #286090; }
        .hidden { display: none; }
        #status, #error { padding: 10px; border-radius: 5px; margin-top: 10px; }
        #status { background-color: #dff0d8; }
        #error { background-color: #f2dede; color: #a94442; }
        textarea { height: 200px; }
    </style>
</head>
<body>

    <h1>Automatikus Feliratozó és Fordító</h1>

    <!-- 1. LÉPÉS: FÁJL FELTÖLTÉSE -->
    <div class="container">
        <h2>1. Lépés: Médiafájl feltöltése</h2>
        <p>Válaszd ki az átírandó hang- vagy videófájlt. A fájl feltöltődik a Google Drive-ra.</p>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="file" required>
            <button type="submit">Feltöltés és Link Generálása</button>
        </form>
        <div id="uploadStatus" class="hidden"></div>
    </div>

    <!-- 2. LÉPÉS: ÁTÍRÁS INDÍTÁSA -->
    <div class="container">
        <h2>2. Lépés: Átírás indítása</h2>
        <label for="speechmaticsApiKey">Speechmatics API Kulcs:</label>
        <input type="password" id="speechmaticsApiKey" placeholder="Írd be a Speechmatics API kulcsodat">
        
        <label for="transcriptionLanguage">Átírás nyelve:</label>
        <select id="transcriptionLanguage">
            <option value="hu">Magyar</option>
            <option value="en">Angol</option>
            <option value="de">Német</option>
            <option value="es">Spanyol</option>
            <option value="fr">Francia</option>
        </select>
        
        <button id="startTranscriptionBtn" disabled>Átírás indítása</button>
        <div id="transcriptionStatus" class="hidden"></div>
    </div>

    <!-- 3. LÉPÉS: FORDÍTÁS -->
    <div id="translationSection" class="container hidden">
        <h2>3. Lépés: Fordítás</h2>
        <label for="originalSrt">Eredeti SRT szöveg:</label>
        <textarea id="originalSrt" readonly></textarea>

        <label for="geminiApiKey">Gemini API Kulcs:</label>
        <input type="password" id="geminiApiKey" placeholder="Írd be a Gemini API kulcsodat">

        <label for="targetLanguage">Célnyelv:</label>
        <input type="text" id="targetLanguage" value="magyar">

        <label for="videoContextFile">Videó kontextus (opcionális):</label>
        <input type="file" id="videoContextFile">

        <button id="translateBtn">Fordítás</button>
        
        <div id="translationStatus" class="hidden"></div>
        
        <label for="translatedSrt">Fordított SRT szöveg:</label>
        <textarea id="translatedSrt" readonly></textarea>
    </div>

    <div id="error" class="hidden"></div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const startTranscriptionBtn = document.getElementById('startTranscriptionBtn');
        const transcriptionStatus = document.getElementById('transcriptionStatus');
        const translationSection = document.getElementById('translationSection');
        const originalSrt = document.getElementById('originalSrt');
        const translateBtn = document.getElementById('translateBtn');
        const translatedSrt = document.getElementById('translatedSrt');
        const translationStatus = document.getElementById('translationStatus');
        const errorDiv = document.getElementById('error');

        let publicMediaUrl = '';
        let transcriptionJobId = '';

        // --- ÚJ FELTÖLTÉSI LOGIKA ---
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!fileInput.files.length) {
                showError('Kérlek, válassz egy fájlt!');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            showStatus(uploadStatus, 'Fájl feltöltése a szerverre és a Google Drive-ra... Ez eltarthat egy ideig.');
            startTranscriptionBtn.disabled = true;

            try {
                const response = await fetch('/upload-to-drive', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Ismeretlen hiba a feltöltés során.');
                }

                publicMediaUrl = data.public_url;
                showStatus(uploadStatus, `Sikeres feltöltés! Nyilvános link: ${publicMediaUrl}`);
                startTranscriptionBtn.disabled = false;

            } catch (err) {
                showError(`Feltöltési hiba: ${err.message}`);
                startTranscriptionBtn.disabled = true;
            }
        });

        // --- ÁTÍRÁS LOGIKA (VÁLTOZATLAN) ---
        startTranscriptionBtn.addEventListener('click', async () => {
            const apiKey = document.getElementById('speechmaticsApiKey').value;
            const language = document.getElementById('transcriptionLanguage').value;

            if (!apiKey) {
                showError('Kérlek, add meg a Speechmatics API kulcsot!');
                return;
            }
            if (!publicMediaUrl) {
                showError('Először tölts fel egy fájlt!');
                return;
            }

            showStatus(transcriptionStatus, 'Átírási feladat elküldve...');

            try {
                const response = await fetch('/start-transcription-from-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: publicMediaUrl, apiKey, language })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                transcriptionJobId = data.job_id;
                showStatus(transcriptionStatus, `Feladat elküldve, Job ID: ${transcriptionJobId}. Státusz lekérdezése...`);
                checkTranscriptionStatus();
            } catch (err) {
                showError(`Átírási hiba: ${err.message}`);
            }
        });

        function checkTranscriptionStatus() {
            const apiKey = document.getElementById('speechmaticsApiKey').value;
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/transcription-status/${transcriptionJobId}?apiKey=${apiKey}`);
                    const data = await response.json();

                    if (!response.ok) {
                        clearInterval(interval);
                        throw new Error(data.error);
                    }
                    
                    showStatus(transcriptionStatus, `Átírás állapota: ${data.status}`);

                    if (data.status === 'done') {
                        clearInterval(interval);
                        showStatus(transcriptionStatus, 'Átírás sikeresen befejeződött!');
                        originalSrt.value = data.srt_content;
                        translationSection.classList.remove('hidden');
                    } else if (data.status === 'error') {
                        clearInterval(interval);
                        showError(`Átírási hiba: ${data.error}`);
                    }
                } catch (err) {
                    clearInterval(interval);
                    showError(`Státusz lekérdezési hiba: ${err.message}`);
                }
            }, 5000); // 5 másodpercenként kérdez le
        }

        // --- FORDÍTÁS LOGIKA (VÁLTOZATLAN) ---
        translateBtn.addEventListener('click', async () => {
            const srtText = originalSrt.value;
            const geminiApiKey = document.getElementById('geminiApiKey').value;
            const targetLanguage = document.getElementById('targetLanguage').value;
            const videoContextFile = document.getElementById('videoContextFile').files[0];

            if (!srtText || !geminiApiKey) {
                showError('Hiányzó SRT szöveg vagy Gemini API kulcs!');
                return;
            }

            const formData = new FormData();
            formData.append('srtText', srtText);
            formData.append('geminiApiKey', geminiApiKey);
            formData.append('targetLanguage', targetLanguage);
            if (videoContextFile) {
                formData.append('videoContextFile', videoContextFile);
            }

            showStatus(translationStatus, 'Fordítás folyamatban a Gemini segítségével...');
            
            try {
                const response = await fetch('/translate', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                translatedSrt.value = data.translated_text;
                showStatus(translationStatus, 'Fordítás sikeres!');
            } catch (err) {
                showError(`Fordítási hiba: ${err.message}`);
            }
        });

        function showStatus(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>